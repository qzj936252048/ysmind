$(function () {
	jQuery.extend({  
        handleError: function (s, xhr, status, e) {  
            if (s.error) {  
                s.error.call(s.context || s, xhr, status, e);  
            }  
            if (s.global) {  
                (s.context ? jQuery(s.context) : jQuery.event).trigger("ajaxError", [xhr, s, e]);  
            }  
       	},  
        httpData: function (xhr, type, s) {  
            var ct = xhr.getResponseHeader("content-type"),  
    		xml = type == "xml" || !type && ct && ct.indexOf("xml") >= 0,  
    		data = xml ? xhr.responseXML : xhr.responseText;  
            if (xml && data.documentElement.tagName == "parsererror")  
                throw "parsererror";  
            if (s && s.dataFilter)  
                data = s.dataFilter(data, type);  
            if (typeof data === "string") {  
                if (type == "script")  
                    jQuery.globalEval(data);  
                if (type == "json")  
                    data = window["eval"]("(" + data + ")");  
            }  
            return data;  
        }  
    }); 
});
//清空选项框
function clearUser(names,ids){
	$("#"+names).val("");
	$("#"+ids).val("");
}

/**
 * @param targetName 用户输入框的id
 * @param divId 显示查询出来的下拉div的id
 * @param manyDivId 多选的时候，选择的值显示在输入框上方的div的id
 */
function initManySelectedUser(targetName,divId,manyDivId,ids,names,context,canDelete){
	if(ids&&ids!="" && names)
	{
		var userIdArr = ids.split(",");
		var userNameArr = names.split(",");
		for(var i=0;i<userIdArr.length;i++)
		{
			var selectedId = userIdArr[i];
			var selectedName = userNameArr[i];
			var ifAdded = checkRepeat("manySelectDiv",selectedId);
    		if(ifAdded)
    		{
    			
        		var oneUserDiv = "";
        		if(canDelete && canDelete=="yes")
        		{
        			oneUserDiv = "<div class=\"justForManyChoose\" id=\""+selectedId+"\">"+selectedName+"<a href=\"javascript:void(0);\" style='text-decoration:none;' onclick=\"removeOneDiv('"+selectedId+"')\">&nbsp;&nbsp;<img src='"+context+"/commons/images/t03.png' width='13' height='12'></a></div>";
        		}
        		else
        		{
        			oneUserDiv = "<div class=\"justForManyChoose\" id=\""+selectedId+"\">"+selectedName+"</div>";
        		}
        		$("#"+manyDivId).append(oneUserDiv);
    		}
		}
	}
}

function initRadioValues(radioArr){
	if(radioArr&&radioArr.length>0)
	{
		for(var i=0;i<radioArr.length;i++){
			var savedValue = radioArr[i][1];
			if(savedValue)
			{
				$("input[name='"+radioArr[i][0]+"'][value='"+savedValue+"']").prev().click();
			}
			else
			{
				$("input[name='"+radioArr[i][0]+"'][value='"+radioArr[i][2]+"']").prev().click();
			}
	   }
	}
}

function initCheckboxValues(checkboxArr){
	if(checkboxArr&&checkboxArr.length>0)
	{
		for(var i=0;i<checkboxArr.length;i++){
			var savedValue = checkboxArr[i][1];
			if(savedValue)
			{
				var arr = savedValue.split(",");
				for(var i=0;i<arr.length;i++)
				{
					$("input[name='"+checkboxArr[i][0]+"'][value='"+arr[i]+"']").prev().click();
				}
			}
			else
			{
				$("input[name='"+checkboxArr[i][0]+"'][value='"+checkboxArr[i][2]+"']").prev().click();
			}
	   }
	}
}

//打印的时候从已经选择的工艺路线中选择需要打印的工艺路线
function printGyxhChooseR(context,testSampleId,printType)
{
	//var testSampleId = "${testSample.id}";
	art.dialog.data("returnValue","");
	var url = context+"/form/testSample/openGongyiChoose?testSampleId="+testSampleId;
	art.dialog.open(url, {
		id : 'openGongyiChoose',
		title : '选择工艺路线',
		width : '350px',
		height : '500px',
		lock : true,
		opacity : 0.1,// 透明度  
		close : function() {
			var returnObj = art.dialog.data("returnValue");
			if(returnObj&&returnObj.length>0)
			{
				var ids = "";
				for(var i=0;i<returnObj.length;i++)
				{
					ids+=returnObj[i][2]+",";
					//暂时选择了多少个就弹出多少个页面
					if("immediately"==printType)
					{
						printImmediately(returnObj[i][2]);
					}
					else
					{
						var url = context+"/form/testSample/printPage?printPage=printPage&id="+testSampleId+"&gylxIds="+returnObj[i][2];
						printPageR(url);
					}
				}
			}
		}
	}, false);
}

function printPage(){
	var headstr = "<html><head><title></title></head><body>"; 
	var footstr = "</body>"; 
	var newstr = document.all.item("printPageId").innerHTML; 
	var oldstr = document.body.innerHTML; 
	document.body.innerHTML = headstr+newstr+footstr; 
	window.print(); 
	document.body.innerHTML = oldstr; 
	return false; 
}


function printPageR(url){
	//var url = "${ctx}/form/createProject/form?printPage=printPage&id="+id;
	art.dialog.open(url, {
		id : randomString(20),
		title : '打印预览',
		width : '900px',
		height : '615px',
		lock : true,
		opacity : 0.1,// 透明度  
		close : function() {
		}
	}, false);
}

function showDisable(){
	//默认先把所有输入框禁用
	$("select").attr("disabled","disabled");
	$("input").attr("disabled","disabled");
    $("checkbox").attr("disabled","disabled");
    $("radio").attr("disabled","disabled");
    $("textarea").attr("disabled","disabled");

	$("#remarks").attr("disabled",false);
	$("#myfile").attr("disabled",false);
	$("#txtfilename").attr("disabled",false);
	$("#deleteBtn").attr("disabled",false);
	$(".noneedcontroll").attr("disabled",false);
	
	/*$(".needControlRadio input:radio").iCheck('disable');
	$(".needControlCheckbox input:checkbox").iCheck('disable');*/
	
	$(".qingkong").css("display","none");
	
	if(typeof(comboboxArr) != "undefined"  && comboboxArr.length>0)
	{
		for(var i=0;i<comboboxArr.length;i++)
		{
			var selectedVal = $('#'+comboboxArr[i]).combobox("getValue");  
			$('#'+comboboxArr[i]).combobox({ disabled: true }); 
			$('#'+comboboxArr[i]).combobox("setValue",selectedVal);
		}
	}
	if(typeof(iCombotreegridArr) != "undefined"  && iCombotreegridArr.length>0)
	{
		for(var i=0;i<iCombotreegridArr.length;i++)
		{
			$('#'+iCombotreegridArr[i]).iCombotreegrid({ disabled: true,width:350 });  
		}
	}
	/*if(dateboxArr && dateboxArr.length>0)
	{
		for(var i=0;i<dateboxArr.length;i++)
		{
			$('#'+dateboxArr[i]).datebox({ "disabled": true});  
		}
	}*/
	
	//$('#combotreeid').combotree({ disabled: true });  
	//$('#dateboxid').datebox({ disabled: true });  
	//$('#datetimeboxid').datetimebox({ disabled: true }); 
	
}

//涉及到项目的流程审批变动的，即使放开修改也不给修改
function mustToDisable(){
	if(typeof(comboboxArrMustDisable) != "undefined" && comboboxArrMustDisable.length>0)
	{
		for(var i=0;i<comboboxArrMustDisable.length;i++)
		{
			var selectedVal = $('#'+comboboxArrMustDisable[i]).combobox("getValue");  
			//$('#'+comboboxArrMustDisable[i]).combobox({ "readonly": true }); 
			$('#'+comboboxArrMustDisable[i]).combobox({ disabled: true }); 
			$('#'+comboboxArrMustDisable[i]).combobox("setValue",selectedVal);  
		}
	}
	if(typeof(iCombotreegridArrMustDisable) != "undefined" && iCombotreegridArrMustDisable.length>0)
	{
		for(var i=0;i<iCombotreegridArrMustDisable.length;i++)
		{
			$('#'+iCombotreegridArrMustDisable[i]).iCombotreegrid({ "readonly": true,width:350 });  
		}
	}
	if(typeof(radioArrMustDisable) != "undefined" && radioArrMustDisable.length>0)
	{
		for(var i=0;i<radioArrMustDisable.length;i++)
		{
			$(".needControlRadio input:radio[name='"+radioArrMustDisable[i]+"']").iCheck('disable');
		}
	}
	
}

function removeDisableSimple(){
	//默认先把所有输入框禁用
	$("select").attr("disabled",false);
	$("input").attr("disabled",false);
    $("checkbox").attr("disabled",false);
    $("radio").attr("disabled",false);
    $("textarea").attr("disabled",false);
    $("#remarks").attr("disabled",false);
	$("#myfile").attr("disabled",false);
	$("#txtfilename").attr("disabled",false);
	$("#deleteBtn").attr("disabled",false);
	$(".noneedcontroll").attr("disabled",false);
	
	$(".qingkong").css("display","");
}

function removeDisable(){
	//默认先把所有输入框禁用
	$("select").attr("disabled",false);
	$("input").attr("disabled",false);
    $("checkbox").attr("disabled",false);
    $("radio").attr("disabled",false);
    $("textarea").attr("disabled",false);
    $("#remarks").attr("disabled",false);
	$("#myfile").attr("disabled",false);
	$("#txtfilename").attr("disabled",false);
	$("#deleteBtn").attr("disabled",false);
	$(".noneedcontroll").attr("disabled",false);
	
	/*$(".needControlRadio input:radio").iCheck('enable');  
	$(".needControlCheckbox input:checkbox").iCheck('enable');  */
	
	$(".qingkong").css("display","");
	
	if(typeof(comboboxArr) != "undefined" && comboboxArr.length>0)
	{
		for(var i=0;i<comboboxArr.length;i++)
		{
			var selectedVal = $('#'+comboboxArr[i]).combobox("getValue");  
			$('#'+comboboxArr[i]).combobox({ disabled: false });  
			$('#'+comboboxArr[i]).combobox({ "readonly": false });  
			$('#'+comboboxArr[i]).combobox("setValue",selectedVal);  
		}
	}
	if(typeof(iCombotreegridArr) != "undefined" && iCombotreegridArr.length>0)
	{
		for(var i=0;i<iCombotreegridArr.length;i++)
		{
			$('#'+iCombotreegridArr[i]).iCombotreegrid({ disabled: false,width:350 });  
		}
	}
	var flowStatus = $("#flowStatus").val();
	if(flowStatus && "create"!=flowStatus)
	{
		mustToDisable();
	}
	
}



//退回的时候必须填写审批意见
function judgeRemarkWhenReturn(){
	var remarks = $("#remarks").val();
	if(!remarks || ""==remarks)
	{
		alert("退回的时候必须填写审批意见.");
		$("#remarks").focus();
		return false;
	}
	return true;
}

function selectCustomers(context,customerId,customerName,customerNumber,officeId){
	var selectOfficeId = $("#"+officeId).val();
	if(!selectOfficeId)
	{
		//art.dialog.alert("请先选择归属公司");
		$.iMessager.alert({title: "提示", msg: "请先选择归属公司",top:150});
		return false;
	}
	art.dialog.data("returnValue","");
	var url = context+"/form/customerInfo/list?queryEntrance=fromSelect&ifQueryFromErp=yes&ifSingle=no&type=select&selectOfficeId="+selectOfficeId;
	art.dialog.open(url, {
		id : 'selectCustomers',
		title : '选择客户',
		width : '1100px',
		height : '70%',
		lock : true,
		opacity : 0.1,// 透明度  
		close : function() {
			var returnObj = art.dialog.data("returnValue");
			if(returnObj && returnObj.length>0)
			{
				var projectInvolveGuestId = $("#projectInvolveGuestId").val();
				var projectInvolveGuest = $("#projectInvolveGuest").val();
				var projectInvolveGuestNumber = $("#projectInvolveGuestNumber").val();
				if(!projectInvolveGuestId){projectInvolveGuestId="";}
				if(!projectInvolveGuest){projectInvolveGuest="";}
				if(!projectInvolveGuestNumber){projectInvolveGuestNumber="";}
				if(projectInvolveGuestNumber&&""!=projectInvolveGuestNumber)
				{
					//alert(projectInvolveGuestNumber);
					projectInvolveGuestId+=","+returnObj[0];
					projectInvolveGuest+=","+returnObj[1];
					projectInvolveGuestNumber+=","+returnObj[2];
				}
				else
				{
					projectInvolveGuestId+=returnObj[0];
					projectInvolveGuest+=returnObj[1];
					projectInvolveGuestNumber+=returnObj[2];
				}
				$("#"+customerId).val(projectInvolveGuestId);
				$("#"+customerName).val(projectInvolveGuest);
				$("#"+customerNumber).val(projectInvolveGuestNumber);
			}
		}
	}, false);
}

function clearCustomers(customerId,customerName,customerNumber,requireId)
{
	$("#"+customerId).val("");
	$("#"+customerName).val("");
	$("#"+customerNumber).val("");
	if(requireId)
	{
		$("#"+requireId).validatebox({required: true});
	}
}

//intiMyCombobox初始化之后如果对他做是否必填之类的改变，点击事件就没了，需重新绑定
function addSelectUserSingle(inputId,hiddenId,hiddenName,context){
	//通过下面这种方法实现双击事件
    $("input",$("#"+inputId).next("span")).dblclick(function(){  
    	chooseUser(context+'/sys/role/userSelect?type=single',hiddenId,hiddenName,inputId);
    }) 
}

function intiMyCombobox(inputId,hiddenId,hiddenName,context,required){
	$("#"+inputId).combobox({  
    	required: required,
        valueField: 'id',     
        textField: 'text',   
        filter: function(q, row){  
        	//扩展filter方法，因为combobox就是通过该方法进行自动不全匹配的，源码默认是return row[opts.textField].indexOf(q) ==0;; 表示联想出来的内容以输入内容开头，这样没法达到模糊匹配的需求，所以修改成>-1；
            var opts = $(this).combobox('options');  
            return row[opts.textField].indexOf(q) >-1;;  
        },  
        onSelect:function(record) { 
        	$("#"+hiddenId).val(record.id);
        	$("#"+hiddenName).val(record.text);
        	if(inputId=="developmentManager"){
        		//样品申请选择研发经理后判断研发人员是否必填
        		initYanfajingli("submit");
        	}
        	else if(inputId=="select_dataCollectUserName")
        	{
        		//项目跟踪当选择资料汇总人之后显示保存和提交按钮
        		dynamicSaveAndSubmit();
        	}
        }, 
        /* on:function(record){
        	ondblclick="chooseUser('${ctx}/sys/role/userSelectSingle','researchPrincipalIds','researchPrincipalNames')" ;
        } */
        /* ondblclick: function (n,o) {
            
        }, */
        url:context+'/sys/user/listForChooseAjax'
//        ,
       //下面的写法似乎把自动补全功能覆盖了
//        inputEvents: $.extend({},$.fn.textbox.defaults.inputEvents,{
            /* keyup:function(event){
            	//alert(event.keyCode);//这里可以实现键盘事件
                 if(event.keyCode == 13) {
                	  alert(event.keyCode);
               	} 
            }, */
//            dblclick:function(event){
//            	chooseUser('${ctx}/sys/role/userSelect?type=single','researchPrincipalIds','researchPrincipalNames','select_researchPrincipalNames')
//            }  
//		 })
    });
    //通过下面这种方法实现双击事件
    $("input",$("#"+inputId).next("span")).dblclick(function(){  
    	chooseUser(context+'/sys/role/userSelect?type=single',hiddenId,hiddenName,inputId);
    }) 
}

function intiMyComboboxComm(url,inputId,hiddenId,textBoxName,required){
	$("#"+inputId).combobox({  
    	required: required,
        valueField: 'id',     
        textField: 'text',   
        filter: function(q, row){  
        	//扩展filter方法，因为combobox就是通过该方法进行自动不全匹配的，源码默认是return row[opts.textField].indexOf(q) ==0;; 表示联想出来的内容以输入内容开头，这样没法达到模糊匹配的需求，所以修改成>-1；
            var opts = $(this).combobox('options');  
            return row[opts.textField].indexOf(q) >-1;;  
        },  
        onSelect:function(record) { 
        	$("#"+hiddenId).val(record.id);
        	if(textBoxName)
        	{
        		$("#"+textBoxName).textbox("setValue",record.title);
        	}
        }, 
        url:url
    });
}


function otherValidateR(validateArr){ 
	var pass = true;
    for(var i=0;i<validateArr.length;i++){
	var val = $("#"+validateArr[i][0]).val();
       if(validateArr[i][3]=="need")
       {
       	if(!val)
       	{
       		alert(validateArr[i][2]+" 不能为空！");
       		pass = false;
       		break;
       	}
       }
       if(val && validateArr[i][1]>0)
       {
       	if(val.length>validateArr[i][1])
       	{
       		alert(validateArr[i][2]+" 长度不能超过 "+validateArr[i][1]);
       		pass = false;
       		break;
       	}
       }
   }
   return pass;
} 

function addValidate(elementId,required){
	if(required)
	{
		//$('#'+elementId).attr("data-options","required:true,width:350");
		$('#'+elementId).validatebox({required: true});
	}
	else
	{
		//$('#'+elementId).attr("data-options","required:false,width:350");
		$('#'+elementId).validatebox({required: false});
	}
	//$.parser.parse($('#'+elementId).parent());
	//alert($('#'+elementId).validatebox("isValid"));
}
function addValidateBeforeR(validateArr,ifFromIcheck){
	if(validateArr&&validateArr.length>0)
	{
		for(var i=0;i<validateArr.length;i++){
			var dependElement = validateArr[i][0];
			if(dependElement)
			{
				var equalValue = "";
				if(ifFromIcheck && "yes"==ifFromIcheck)
				{
					equalValue = $("input[name='"+dependElement+"']:checked").val();
				}
				else
				{
					equalValue = $("input[name='"+dependElement+"']:checked").attr("label");
				}
				if(validateArr[i][1]==equalValue)
				{
					var objValue = $("#"+validateArr[i][2]).val();
					if(!objValue || ""==objValue)
					{
						addValidate(validateArr[i][2],true);
					}
				}
				else
				{
					addValidate(validateArr[i][2],false);
				}
			}
	   }
	}
}

/**
 * 表单操作
 * @param formId
 * @param tableName
 * @param context
 * @param formUrl
 * @param recordId
 * @param flowStatus
 * @param currentOperator
 * @param workflowId
 * @param workflowNodeId
 */
function afterLoadPage(formId,tableName,context,formUrl,recordId,flowStatus,currentOperator,workflowId,workflowNodeId,officeOrCompanyId){
	$(".submitButton").bind("click",function(){
		if("form_test_sample"==tableName){getAllValue();}
		//提交之前设置一些验证，根据输入的条件动态判断哪些控件需要做什么限制
		addValidateBefore();
		//防止表单重复提交，点击的时候就让所有提交按钮禁用
		$(".submitButton").attr("disabled","disabled");
		setFormSelect();
		var buttonId = $(this).attr("id");
		if(buttonId && "subForm"==buttonId)
		{
			//如果是提交表单则弹出可选节点参与人
			$("#submitFlag").val("submit");
			var validate = $("#"+formId).form('validate'); 
		    if (!validate) {  
		        /* $.iMessager.alert("确认", '请正确填写表单！',"",function(){  
		        		$("#"+formId).find(".validatebox-invalid:first").focus();  
		        }); */
		        $.iMessager.alert({title:'提示',msg:'请正确填写表单！',icon: 'warm',
                    //width: 200,top:150,
                    fn:function(){
                    	$("#"+formId).find(".validatebox-invalid:first").focus();   
                    }
                });
		        /* art.dialog.alert("请正确填写表单！",function(){  $("#"+formId).find(".validatebox-invalid:first").focus();  }); */
		        return false ; 
		    }  
			if(!otherValidate())
			{
				return;
			}
			if(tableName=="form_project_tracking")
			{
				//发起人和资料汇总人为同一人时，提交的时候需要提示
				var canPassF = withResultValidate();
				if(!canPassF)
				{
					return;
				}
			}
			else if("form_test_sample"==tableName){
				//提交的时候需要填写所有的物料清单审批人
				if(!nodeOne())
				{
					return;
				}
			}
			
		   	//验证通过 处理
			var officeId = $("#officeId").val();
			if(officeOrCompanyId)
			{
				officeId = $("#"+officeOrCompanyId).val();
			}
			if(officeId)
			{
				art.dialog.data("returnValue","");
				var url = context+"/wf/nodeParticipate/showParticipate?formType="+tableName+"&officeId="+officeId;
				art.dialog.open(url, {
		    		id : 'selectFlowParicipates',
		    		title : '选择审批人',
		    		width : '1100px',
		    		height : '80%',
		    		lock : true,
		    		opacity : 0.1,// 透明度  
		    		close : function() {
		    			var returnObj = art.dialog.data("returnValue");
		    			if(returnObj && returnObj[0])
		    			{
		    				removeDisable();
		    				$("#participateOnlySign").val(returnObj[0]);
		    				$("#selectedFlowId").val(returnObj[1]);
		    				$.iMessager.progress({
				                text: "正在操作...",top:$(document).scrollTop()+100
				            });
		    				//var loading = lockAndLoading("数据保存中，请稍等....");
		    				$('#'+formId).ajaxSubmit(function(data){
		    					$.iMessager.progress("close");
		    				    $("#submitTable").css("display","none");
		    				    if(data)
							  	{
							  		if(typeof data == "string")
							  		{
							  			data = $.parseJSON(data.replace(/<.*?>/ig,""));
							  			//data = JSON.parse(data);和上面重复了
							  		}
							  		if(data.status)
							  		{
							  			/* $.iMessager.alert("确认", data.message,"info",function(){  
							  				window.location.href="${ctx}/form/createProject/form?id="+data.entityId+"&recordId=${record.id}";
							        	}); */
							  			$.iMessager.alert({title:'提示',msg:data.message,icon: 'info',
					                        //width: 200,
					                        top:150,
					                        fn:function(){
					                        	var refresh_tab = parent.$('#index_tabs').iTabs('getSelected');
					                            var refresh_iframe = refresh_tab.find('iframe')[0];
					                            refresh_iframe.src=formUrl+"id="+data.entityId;
					                        	window.location.href=formUrl+"id="+data.entityId;//+"&recordId="+recordId; 
					                        }
					                    });
							  			/* art.dialog.alert(data.message,function(){  
							  				window.location.href="${ctx}/form/createProject/form?id="+data[0]+"&onlySign_record="+data[1]+"&recordId=${record.id}";
							        	}); */
							  		}
							  		else
							  		{
							  			$.iMessager.alert({title: data.title, msg: data.message,top:150});
							  			//art.dialog.alert("data.message");
							  			//showDisable();
							  		}
							  	}
		    			 	});
		    			}
		    			else
	    				{
		    				$.iMessager.alert({title: "提示", msg: "审批人选择失败，请重新选择！",top:150});
	    				}
		    		}
		    	}, false);
			}
		}
		else if(buttonId&&"returnAny"==buttonId)
		{
			var canPass  = judgeRemarkWhenReturn();
			if(!canPass)
			{
				return false;
			}
			//alert(canPass);
			art.dialog.data("returnValue","");
			var url = context+"/wf/operationRecord/listReturn?id="+recordId;
			art.dialog.open(url, {
				id : 'returnAny',
				title : '选择节点',
				width : '1000px',
				height : '615px',
				lock : true,
				opacity : 0.1,// 透明度  
				close : function() {
					var returnValue = art.dialog.data("returnValue");
					if(returnValue!="")
					{
						$("#submitFlag").val("returnAny");
						$("#returnToRecordId").val(returnValue);
						if(!otherValidate())
						{
							return;
						}
					   	//验证通过 处理
					 	$.iMessager.progress({
			                text: "正在操作...",top:$(document).scrollTop()+200
			            });
					 	removeDisable();
					    $('#'+formId).ajaxSubmit(function(data){
					    	$.iMessager.progress("close");
						    if(data)
						  	{
						  		if(typeof data == "string")
						  		{
						  			data = $.parseJSON(data.replace(/<.*?>/ig,""));
						  			//data = JSON.parse(data);和上面重复了
						  		}
						  		if(data.status)
						  		{
						  			$.iMessager.alert({title:'提示',msg:data.message,icon: 'info',
				                        //width: 200,
				                        top:150,
				                        fn:function(){
				                        	//window.location.href=formUrl+"id="+data.entityId+"&recordId="+recordId; 
				                        	var refresh_tab = parent.$('#index_tabs').iTabs('getSelected');
				                            var refresh_iframe = refresh_tab.find('iframe')[0];
				                            refresh_iframe.src=context+"/wf/operationRecord/toApprove?recordId="+recordId;
				                        	window.location.href=context+"/wf/operationRecord/toApprove?recordId="+recordId;
				                        }
				                    });
						  		}
						  		else
						  		{
						  			$.iMessager.alert({title: data.title, msg: data.message,top:150});
						  			//showDisable();
						  		}
						  	}else
							{
						  		$.iMessager.alert({title: "提示", msg: "审批人选择失败，请重新选择！",top:150});
							}
					 	});
					}
				}
			}, false);
		}
		else
		{
			var formOperateTpey = $(this).attr("id");
			var operateTitle = $(this).attr("title");
			$("#submitFlag").val($(this).attr("id"));
			var canPass = true;
			if("returnPre"==$(this).attr("id"))
			{
				canPass = judgeRemarkWhenReturn();
			}
			if(!canPass)
			{
				return false;
			}
			//保存表单时候不验证，但是通过的时候是要验证的，因为有些值是在审批的时候填写的
			if(recordId && "pass"==formOperateTpey)
			{
				var validate = $("#"+formId).form('validate'); 
			    if (!validate) {  
			        $.iMessager.alert({title:'提示',msg:'请正确填写表单！',icon: 'warm',
	                    fn:function(){
	                    	$("#"+formId).find(".validatebox-invalid:first").focus();   
	                    }
	                });
			        return false ; 
			    }  
			}
			if(tableName=="form_test_sample")
			{
				checkIfThreeCondition();
				var pastThree = false;
				var val = $("#checkIfCanApproveThree").val();
				if(val && "yes"==val && "pass"==$(this).attr("id"))
				{
					/*$.messager.confirm("提示", "当前协调PPC与排产PPC为同一人,是否确认提交?", function (data) {
						if(data)
						{
							$("#checkIfCanPostThree").val("yes");
							pastThree = true;
						}
					});*/
					if( confirm('当前协调PPC与排产PPC为同一人,是否确认提交?') ) {  
						$("#checkIfCanPostThree").val("yes");
						pastThree = true;
					} else {  
						pastThree = false;
						canPass = false;
						testSampleRoleControll(context);
					}
					
					if(!pastThree)
					{
						return;
					}
				}
				
				//试样单申请,到了第6个节点,协调PPC提交时,要判断,生产审批人跟承诺交货日期,必须有值.
				var nodeSort=$("#nodeSort").val();
				var activeSort=$("#activeSort").val();
				if(canPass && "pass"==$(this).attr("id") && nodeSort==6 && activeSort==6)
				{
					canPass = nodeSix();
				}
				if(!canPass)
				{
					testSampleRoleControll(context);
					return;
				}
				
				if(activeSort && activeSort!=1 && "pass"==$(this).attr("id"))
				{
					//保存的时候需要填写所有的物料清单审批人
					if(!nodeOne())
					{
						testSampleRoleControll(context);
						return;
					}
				}
				if(activeSort && activeSort==8 && "pass"==$(this).attr("id"))
				{
					//回复交货期的时候验证PPC交货日期
					var answerDeliveryDate = $("#answerDeliveryDate").val();
					if(!answerDeliveryDate)
					{
						$.iMessager.alert({title:'提示',msg:'PPC承诺日期不能为空',icon: 'info',top:150,
	                        fn:function(){
	                        	$("#answerDeliveryDate").focus(); 
	                        }
	                    });
						testSampleRoleControll(context);
						return;
					}
				}
			}
			if(canPass)
			{
				canPass = validateBeforeSave($(this).attr("id"));
			}
			if(!canPass)
			{
				return;
			}
			var officeId = $("#officeId").val();
			$.iMessager.progress({
                text: "正在操作...",top:$(document).scrollTop()+200
            });
		 	//var loading = lockAndLoading("数据保存中，请稍等....");
		 	$("#submitTable").css("display","none");
		 	removeDisable();
		    $('#'+formId).ajaxSubmit(function(data){
			    //loading.close();
			    $.iMessager.progress("close");
			    if(data)
			  	{
			  		if(typeof data == "string")
			  		{
			  			data = $.parseJSON(data.replace(/<.*?>/ig,""));
			  			//data = JSON.parse(data);和上面重复了
			  		}
			  		if(data.status)
			  		{
			  			//error、question、info、warning。
			  			/* $.iMessager.alert("确认", data.message,"info",function(){  
			  				window.location.href="${ctx}/form/createProject/form?id="+data.entityId+"&recordId=${record.id}";
			        	});  */
			  		    //width: 200,
			  			$.iMessager.alert({title:'提示',msg:data.message,icon: 'info',top:150,
	                        fn:function(){
	                        	if("readed"==formOperateTpey ||"urge"==formOperateTpey  ||"returnPre"==formOperateTpey||"pass"==formOperateTpey)
	                        	//if("save"!=formOperateTpey)||"getBack"==formOperateTpey取回之后要从表单刷新才能继续操作
	                        	{
	                        		/*if(operateTitle.indexOf("chuanyue")>-1)
	                        		{*/
	                        		var refresh_tab = parent.$('#index_tabs').iTabs('getSelected');
		                            var refresh_iframe = refresh_tab.find('iframe')[0];
		                            refresh_iframe.src=context+"/wf/operationRecord/toApprove?recordId="+recordId;
                        			window.location.href=context+"/wf/operationRecord/toApprove?recordId="+recordId;
	                        		/*}
	                        		else
	                        		{
	                        			window.location.href=formUrl+"id="+data.entityId+"&recordId="+recordId; 
	                        		}*/
	                        	}
	                        	else
	                        	{
	                        		//保存的时候
	                        		if(tableName=="form_test_sample")
	                    			{
	                        			//试样单不刷新
			                            var val = getUrlParamValue("id");
			                            if(!val || ""==val)
			                            {
			                            	$("#id").val(data.entityId);
		                        			var refresh_tab = parent.$('#index_tabs').iTabs('getSelected');
				                            var refresh_iframe = refresh_tab.find('iframe')[0];
			                            	refresh_iframe.src=formUrl+"id="+data.entityId;
			                        		window.location.href=formUrl+"id="+data.entityId;//+"&recordId="+recordId;
			                            }
	                    			}
	                        		else
	                        		{
	                        			var refresh_tab = parent.$('#index_tabs').iTabs('getSelected');
			                            var refresh_iframe = refresh_tab.find('iframe')[0];
			                            refresh_iframe.src=formUrl+"id="+data.entityId;
		                        		window.location.href=formUrl+"id="+data.entityId;//+"&recordId="+recordId;
	                        		}
	                        	}
	                        	//window.location.href=context+"/wf/operationRecord/toApprove?recordId="+recordId;
	                        }
	                    });
			  		}
			  		else
			  		{
			  			$.iMessager.alert({title: data.title, msg: data.message,top:150});
			  			showDisable();
			  		}
			  	}else
				{
    				$.iMessager.alert({title: "提示", msg: "审批人选择失败，请重新选择！",top:150});
				}
		 	});
		}
	}); 
	
	//表单权限控制
	//当前是获取到了审批记录再进来的，并且不是创建状态的则进行权限控制
	if(currentOperator && flowStatus!="create")
	{
		 $.ajax({
	        type: "GET",
	        url: context+"/wf/workflowRole/getRoleDetailByUser",
	        data: {flowId:workflowId,nodeId:workflowNodeId,formId:formId},
	        dataType: "json",
	        success: function(data){
	       		if(data && data.length>1)
	      		{
	       			operModifyArr = data[0];
	       			operQueryArr = data[1];
	       			if(operModifyArr && operModifyArr.length>0)
	      			{
	       				for(var i=0;i<operModifyArr.length;i++)
	      				{
	       					$("#"+operModifyArr[i]).attr("disabled",false);
	       					$("input[name='"+operModifyArr[i]+"']").attr("disabled",false);
	      				}
	      			}
	       			if(operQueryArr && operQueryArr.length>0)
	      			{
	       				for(var i=0;i<operQueryArr.length;i++)
	       				{
	       					$("#"+operQueryArr[i]).css("display","none");
	      				}
	      			}
	      		}
	        }
	    }); 
	}
	
	//点击层外，隐藏这个层。由于层内的事件停止了冒泡，所以不会触发这个事件  
	$(document).click(function(e){                         
	    $(".thisDivNeedToHide").hide();  
	    var allDiv = $(".thisDivNeedToHide");
	    if(allDiv && allDiv.length>0)
	    {
	    	for(var i=0;i<allDiv.length;i++)
	    	{
	    		var name = $(allDiv[i]).attr("title");
	    		var idValue = $("#"+name+"Ids").val();
	    		if(!idValue || ""==idValue)
	    		{
	    			$("#"+name+"Names").val("");
	    		}
	    		var idValueS = $("#"+name+"Id").val();
	    		if(!idValueS || ""==idValueS)
	    		{
	    			$("#"+name+"Name").val("");
	    		}
	    	}
	    }
	});
	
	
	intiAutoHeight();
	
	initCompany("officeName","officeId",context);
}

/**
 * 解析url的值
 * @param key
 * @returns {Object}
 */
function getUrlParamValue(mykey){
	var url = location.search; //获取url中"?"符后的字串
    var theRequest = "";
    if (url.indexOf("?") != -1) {
        var str = url.substr(1);
        strs = str.split("&");
        for(var i = 0; i < strs.length; i ++) {
        	var key = strs[i].split("=")[0];
            var value = strs[i].split("=")[1];
            if(mykey==key)
            {
            	return value;
            }
        }
    }
    return theRequest;
}

function intiAutoHeight(){
	$.fn.autoHeight = function(){
		function autoHeight(elem){
			elem.style.height = 'auto';
			elem.scrollTop = 0; //防抖动
			elem.style.height = elem.scrollHeight + 'px';
		}
		this.each(function(){
			autoHeight(this);
			$(this).on('keyup', function(){
				autoHeight(this);
			});
		});
	}
	$('textarea[autoHeight]').autoHeight();
}

function initCompany(inputName,inputId,context,width){
	if($('#'+inputName))
	{
		if(!width){width=350}
		//初始化部门选择
	    $('#'+inputName).iCombotreegrid({
	        width: width,
	        labelPosition: 'top',
	        url: context+'/sys/office/getListByParentId?parentId=1',
	        expandUrl: context+'/sys/office/getListByParentId?parentId={id}',
	        idField: 'id',
	        treeField: 'name',
	        required: true,
	        columns: [[
	            {field: 'name', title: '机构名称'},
	            {field: 'code', title: '机构编码', width: 100}
	        ]],
	        onSelect:function(record) {  
	        	$('#'+inputId).val(record.id);
	        }
	    });
	}
}

/**
 * 传阅
 * @param recordId
 * @param context
 */
function circularizeBatch(recordId,context){
	if(recordId)
	{
		art.dialog.data("returnValue","");
		art.dialog.open(context+'/sys/role/userSelect', {
			id : 'chooseUser',
			title : '选择用户',
			width : '900px',
			height : '615px',
			lock : true,
			opacity : 0.1,// 透明度  
			close : function() {
				var returnValue = art.dialog.data("returnValue");
				if(returnValue!="" && returnValue.length>0)
				{
					if(returnValue && returnValue.length>0&&returnValue[0]!=''&&returnValue[0]!='-1')
					{
						$.ajax({
					        url: context+"/wf/operationRecord/circularizeBatch",
					        type: "get",
					        data: {"recordId":recordId,"toUserIds":returnValue[0]},
					        dataType: "json",
					        async: !1,
					       // contentType: "application/x-www-form-urlencoded;charset=utf-8",//"application/json;charset=utf-8"
					        beforeSend: function () {
					            $.messager.progress({
					                text: "正在操作..."
					            })
					        }, success: function (data) {
					            $.messager.progress("close");
					            if(data)
							  	{
							  		if(typeof data == "string")
							  		{
							  			data = JSON.parse(data);
							  		}
							  		if(data.status)
							  		{
							  			$.messager.alert("确认", data.message,"",function(){  
							  				window.location.href=context+"/wf/operationRecord/toApprove?recordId="+recordId;
							        	}); 
							  		}
							  		else
							  		{
							  			$.iMessager.alert({title: data.title, msg: data.message});
							  		}
							  	}
					        }, error: function(data){
					        	$.messager.progress("close");
					        	if(data)
							  	{
							  		if(typeof data == "string")
							  		{
							  			data = JSON.parse(data);
							  		}
							  		if(data.status)
							  		{
							  			$.messager.alert("确认", data.message,"",function(){  
							  				window.location.href=context+"/wf/operationRecord/toApprove?recordId="+recordId;
							        	}); 
							  		}
							  		else
							  		{
							  			$.iMessager.alert({title: data.title, msg: data.message});
							  		}
							  	}
					        }
					    })
					}
				}
			}
		}, false);
	}
}


/**
 * 授权审批
 * @param recordId
 * @param context
 */
function accreditBatch(recordId,context){
	$.messager.confirm("提示", "确认授权当前审批么？", function (data) {
		if(data)
		{
			if(recordId)
			{
				art.dialog.data("returnValue","");
				art.dialog.open(context+'/sys/role/userSelect?type=single', {
					id : 'chooseUser',
					title : '选择用户',
					width : '900px',
					height : '615px',
					lock : true,
					opacity : 0.1,// 透明度  
					close : function() {
						var returnValue = art.dialog.data("returnValue");
						if(returnValue!="" && returnValue.length>0)
						{
							if(returnValue && returnValue.length>0&&returnValue[0]!=''&&returnValue[0]!='-1')
							{
								$.ajax({
							        url: context+"/wf/operationRecord/accreditBatch",
							        type: "get",
							        data: {"allVal":recordId,"toUserIds":returnValue[0]},
							        dataType: "json",
							        async: !1,
							       // contentType: "application/x-www-form-urlencoded;charset=utf-8",//"application/json;charset=utf-8"
							        beforeSend: function () {
							            $.messager.progress({
							                text: "正在操作..."
							            })
							        }, success: function (data) {
							            $.messager.progress("close");
							            if(data)
									  	{
									  		if(typeof data == "string")
									  		{
									  			data = JSON.parse(data);
									  		}
									  		if(data.status)
									  		{
									  			$.messager.alert("确认", data.message,"",function(){  
									  				window.location.href=context+"/wf/operationRecord/toApprove?recordId="+recordId;
									        	}); 
									  		}
									  		else
									  		{
									  			$.iMessager.alert({title: data.title, msg: data.message});
									  		}
									  	}
							        }, error: function(data){
							        	$.messager.progress("close");
							        	if(data)
									  	{
									  		if(typeof data == "string")
									  		{
									  			data = JSON.parse(data);
									  		}
									  		if(data.status)
									  		{
									  			$.messager.alert("确认", data.message,"",function(){  
									  				window.location.href=context+"/wf/operationRecord/toApprove?recordId="+recordId;
									        	}); 
									  		}
									  		else
									  		{
									  			$.iMessager.alert({title: data.title, msg: data.message});
									  		}
									  	}
							        }
							    })
							}
						}
					}
				}, false);
			}
		}
	});
}

function sendEmail(url,recordId){
	var participateIds = "";
	$('input[name="participates"]:checked').each(function() {  
		participateIds += $(this).val()+";";  
	});  
	if(participateIds)
	{
		$.messager.confirm('确认','发送此邮件表示审批已完成，确认发送邮件?',function(data){  
	  		if(data)
	  		{
  	              $.ajax({  
  	              	type: "get",
  	              	url: url,
  	              	data: {recordId:recordId,userIdList:participateIds},
  	                  beforeSend: function () {
  				            $.messager.progress({
  				                text: "正在操作..."
  				            })
  				        },
  	                  success: function (data) {
  				            $.messager.progress("close");
  				            if(data)
  						  	{
  						  		if(typeof data == "string")
  						  		{
  						  			data = JSON.parse(data);
  						  		}
  						  		if(data.status)
  						  		{
  						  			$.iMessager.alert({title: data.title, msg: data.message}); 
  						  		}
  						  		else
  						  		{
  						  			$.iMessager.alert({title: data.title, msg: data.message});
  						  		}
  						  	}
  				        }, error: function(data){
  				        	$.messager.progress("close");
  				        	if(data)
  						  	{
  						  		if(typeof data == "string")
  						  		{
  						  			data = JSON.parse(data);
  						  		}
  						  		if(data.status)
  						  		{
  						  			$.iMessager.alert({title: data.title, msg: data.message});
  						  		}
  						  		else
  						  		{
  						  			$.iMessager.alert({title: data.title, msg: data.message});
  						  		}
  						  	}
  				        }
  	              });
	  		  }
	      })
	}
}